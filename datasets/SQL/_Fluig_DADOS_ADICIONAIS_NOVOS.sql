USE [corporerm_HOMOLOG]
GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER OFF
GO

/* ATENCAO - ESTA VIEW RETORNA USUARIOS QUE NÃO POSSUEM DADOS ADICIONAIS */

ALTER view _Fluig_DADOS_ADICIONAIS_NOVOS AS

	--/****** Script do comando SelectTopNRows de SSMS  ******/

SELECT 
	PFUNC.CHAPA,
	PPESSOA.NOME AS NOME_COMPLETO,
	Substring(Ltrim(Rtrim(PPESSOA.NOME)), 1, Case When (Charindex(' ', Ltrim(Rtrim(PPESSOA.NOME))) - 1) < 0 Then Len(Ltrim(Rtrim(PPESSOA.NOME))) Else Charindex(' ', Ltrim(Rtrim(PPESSOA.NOME))) - 1 End)  AS NOME_PRIMEIRO,
	REPLACE(PPESSOA.NOME,(Substring(Ltrim(Rtrim(PPESSOA.NOME)), 1, Case When (Charindex(' ', Ltrim(Rtrim(PPESSOA.NOME))) - 1) < 0 Then Len(Ltrim(Rtrim(PPESSOA.NOME))) Else Charindex(' ', Ltrim(Rtrim(PPESSOA.NOME))) - 1 End)),'') AS NOME_SOBRENOME,
	CONVERT(VARCHAR(10), PFUNC.DATAADMISSAO, 103) AS DATAADMISSAO,
	CONVERT(VARCHAR(10), PPESSOA.DTNASCIMENTO, 103) AS DATANASCIMENTO,
	SUBSTRING(CONVERT(VARCHAR(10), PPESSOA.DTNASCIMENTO, 103),1,2) AS DATANASCIMENTO_DIA,
	SUBSTRING(CONVERT(VARCHAR(10), PPESSOA.DTNASCIMENTO, 103),4,2) AS DATANASCIMENTO_MES,
	PPESSOA.CPF,
	'('+SUBSTRING(PPESSOA.TELEFONE1,1,2)+') '+ SUBSTRING(PPESSOA.TELEFONE1,3,8) AS TELEFONE,
	LOWER(GUSUARIO.CODUSUARIO) CODUSUARIO,
	LOWER(GUSUARIO.EMAIL) EMAIL,
	CASE WHEN PPESSOA.SEXO = 'M' THEN 'masculino' ELSE  'feminino' END AS GENERO,
	PSECAO.DESCRICAO AS NOME_DEPARTAMENTO,
	CASE WHEN PSECAO.CODFILIAL = 1 THEN 'CNC - DF' ELSE 'CNC - RJ' END AS NOME_UNIDADE,
	CASE WHEN PSECAO.CODFILIAL = 1 THEN '01' ELSE '02' END AS EMPRESA,
	PSECAO.NROCENCUSTOCONT AS DEPARTAMENTO,
	PFUNCAO.CODIGO AS CARGO_COD,
	PFUNCAO.NOME AS CARGO_NOME

	FROM PFUNC 
			JOIN PPESSOA	ON (PFUNC.CODPESSOA=PPESSOA.CODIGO)
			JOIN GUSUARIO	ON (PPESSOA.CODUSUARIO=GUSUARIO.CODUSUARIO)
			JOIN PSECAO		ON (PFUNC.CODSECAO=PSECAO.CODIGO)
			JOIN PFUNCAO	ON (PFUNC.CODFUNCAO=PFUNCAO.CODIGO)
			
	WHERE	PFUNC.CODSITUACAO <> 'D'
	AND		GUSUARIO.CODUSUARIO NOT IN (SELECT login COLLATE Latin1_General_CI_AS FROM [RIOSRV010\DSEN].[Fluig_homolog].[dbo].[ML001041])
	-- PRODUÇÃO AND		GUSUARIO.CODUSUARIO NOT IN (SELECT login COLLATE Latin1_General_CI_AS FROM [RIOSRV013\SISTEMA].[FLUIG_DB].[dbo].[ML001041])

GO